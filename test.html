<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Карта регионов России с университетами (2023 год)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #map {
            height: 100vh;
            width: 100vw;
            background: #f0f0f0;
        }
        /* Стили для боковой панели */
        #sidebar {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            width: 200px;
        }
        #sidebar h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
        }
        #sidebar label {
            display: block;
            margin: 5px 0;
        }
        /* Поиск */
        #search-bar {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        /* Легенда */
        #legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <!-- Поисковая панель -->
    <div id="search-bar">
        <input type="text" id="search-input" placeholder="Поиск по направлениям..." style="width: 200px;">
    </div>

    <!-- Боковая панель с фильтрами -->
    <div id="sidebar">
        <h3>Фильтр университетов</h3>
        <label>
            <input type="checkbox" id="filter-construction" checked> Строительные
        </label>
        <label>
            <input type="checkbox" id="filter-pedagogy" checked> Педагогические
        </label>
        <label>
            <input type="checkbox" id="filter-transport" checked> Транспортные
        </label>
        <label>
            <input type="checkbox" id="filter-engineering" checked> Машиностроительные
        </label>
        <label>
            <input type="checkbox" id="filter-service" checked> Сервис и финансы
        </label>
        <label>
            <input type="checkbox" id="filter-agriculture" checked> Сельское хозяйство
        </label>
        <label>
            <input type="checkbox" id="filter-medicine" checked> Медицинские
        </label>
        <label>
            <input type="checkbox" id="filter-technical" checked> Технические
        </label>
        <label>
            <input type="checkbox" id="filter-other" checked> Другие
        </label>
    </div>

    <!-- Легенда -->
    <div id="legend">
        <h4>Изменение числа студентов (2020-2023)</h4>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #006837;"></div>
            <span>Сильный рост (>20%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #78c679;"></div>
            <span>Рост (5-20%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffffcc;"></div>
            <span>Незначительные изменения (±5%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #fd8d3c;"></div>
            <span>Снижение (5-20%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #e31a1c;"></div>
            <span>Сильное снижение (>20%)</span>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <script>
        // Инициализация карты
        var map = L.map('map', {
            minZoom: 2,
            maxZoom: 18
        }).setView([55.7558, 37.6176], 4);

        // Добавляем слой карты (например, OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Создаем кластер для маркеров
        var markersCluster = L.markerClusterGroup();

        // Загрузка данных регионов из файла data.json
        let regionLayers = {};
        let regionData = {};
        
        fetch('data.json')
            .then(response => response.json())
            .then(data => {
                // Сохраняем данные регионов для дальнейшего использования
                regionData = data;
            })
            .catch(error => console.error('Ошибка загрузки данных регионов:', error));

        // Функция для определения категории университета
        function getUniversityCategory(universityName) {
            if (universityName.match(/строительный|строительство|архитектурный|архитектура|градостроительный|градостроительство|проектирование|инженерно-строительный/i)) {
                return 'construction';
            } else if (universityName.match(/педагог|образование|педагогика|учитель|преподавание|воспитание|образовательный/i)) {
                return 'pedagogy';
            } else if (universityName.match(/трансп|транспорт|логистика|автомобильный|железнодорожный|авиа|судоходный|перевозки/i)) {
                return 'transport';
            } else if (universityName.match(/машиностроительный|машиностроение|механический|автомеханический|автомоб|станкостроение|робототехника/i)) {
                return 'engineering';
            } else if (universityName.match(/сервис|социаль|туризм|общественное питание|ресторанный|гостиничный|гуман/i) && !universityName.match(/финансы/i)) {
                return 'service';
            } else if (universityName.match(/сервис|финансы|банковское дело|бухгалтерия|эконом|финанс|бизнес/i)) {
                return 'service';
            } else if (universityName.match(/сельское хозяйство|аграр|сель|агротехника|фермерство|земледелие|агропромышленный/i)) {
                return 'agriculture';
            } else if (universityName.match(/медицинский|мед|здравоохранение|фармацевтика|стоматология|хирургия|врач|больница/i)) {
                return 'medicine';
            } else if (universityName.match(/техни|технический|инженерный|технологический|электротехника|радиотех|энерг|техноло|ядер/i)) {
                return 'technical';
            } else {
                return 'other';
            }
        }

        // Функция для получения направлений университета
        function getUniversityPrograms(universityName) {
            const programs = [];
            const university = universityData.find(u => u.name === universityName);
            if (university && university.analis_reg_data) {
                university.analis_reg_data.forEach(item => {
                    programs.push(item["Реализуемые УГН(С)"]);
                });
            }
            return programs.join(', ');
        }

        // Функция для выбора иконки на основе названия университета
        function getUniversityIcon(universityName) {
            let iconUrl;

            if (universityName.match(/строительный|строительство|архитектурный|архитектура|градостроительный|градостроительство|проектирование|инженерно-строительный/i)) {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/1_SSO.png';
            } else if (universityName.match(/педагог|образование|педагогика|учитель|преподавание|воспитание|образовательный/i)) {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/2_SPO.png';
            } else if (universityName.match(/трансп|транспорт|логистика|автомобильный|железнодорожный|авиа|судоходный|перевозки/i)) {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/10_SOZHT_1.png';
            } else if (universityName.match(/машиностроительный|машиностроение|механический|автомеханический|автомоб|станкостроение|робототехника/i)) {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/3_SOP.png';
            } else if (universityName.match(/сервис|социаль|туризм|общественное питание|ресторанный|гостиничный|гуман/i) && !universityName.match(/финансы/i)) {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/4_SServO.png';
            } else if (universityName.match(/сервис|финансы|банковское дело|бухгалтерия|эконом|финанс|бизнес/i)) {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/4_SServO.png';
            } else if (universityName.match(/сельское хозяйство|аграр|сель|агротехника|фермерство|земледелие|агропромышленный/i)) {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/5_SSkhO.png';
            } else if (universityName.match(/медицинский|мед|здравоохранение|фармацевтика|стоматология|хирургия|врач|больница/i)) {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/6_SMO.png';
            } else if (universityName.match(/техни|технический|инженерный|технологический|электротехника|радиотех|энерг|техноло|ядер/i)) {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/8_SPrO.png';
            } else {
                iconUrl = 'https://xn--d1amqcgedd.xn--p1ai/media/icons/9_Spetcializirovannye.png';
            }

            return L.icon({
                iconUrl: iconUrl,
                iconSize: [35, 35],
                iconAnchor: [12, 25],
                popupAnchor: [0, -25]
            });
        }

        // Загрузка данных университетов и направлений
        let universityData = [];
        let universityData2020 = []; // Данные за 2020 год
        
        // Функция для загрузки данных университетов
        function loadUniversityData() {
            return Promise.all([
                fetch('universities_parsed_data_2023.json').then(res => res.json()),
                fetch('universities_parsed_data_2020.json').then(res => res.json()) // Предполагаем, что у вас есть такой файл
            ]).then(([data2023, data2020]) => {
                universityData = data2023;
                universityData2020 = data2020;
                
                // Анализируем изменения и обновляем карту
                analyzeRegionChanges();
                updateMarkers();
            });
        }

        // Функция для анализа изменений по регионам
        function analyzeRegionChanges() {
            // Создаем объект для хранения данных по регионам
            const regionChanges = {};
            
            // Сначала собираем данные за 2023 год
            universityData.forEach(university => {
                const region = university.region;
                if (!regionChanges[region]) {
                    regionChanges[region] = {
                        total2023: 0,
                        total2020: 0,
                        programs: {}
                    };
                }
                
                university.analis_reg_data.forEach(program => {
                    const programName = program["Реализуемые УГН(С)"];
                    const students = parseFloat(program["Приведенный контингент студентов"].replace(',', '.'));
                    
                    regionChanges[region].total2023 += students;
                    
                    if (!regionChanges[region].programs[programName]) {
                        regionChanges[region].programs[programName] = {
                            students2023: 0,
                            students2020: 0
                        };
                    }
                    regionChanges[region].programs[programName].students2023 += students;
                });
            });
            
            // Затем собираем данные за 2020 год
            universityData2020.forEach(university => {
                const region = university.region;
                if (!regionChanges[region]) {
                    regionChanges[region] = {
                        total2023: 0,
                        total2020: 0,
                        programs: {}
                    };
                }
                
                university.analis_reg_data.forEach(program => {
                    const programName = program["Реализуемые УГН(С)"];
                    const students = parseFloat(program["Приведенный контингент студентов"].replace(',', '.'));
                    
                    regionChanges[region].total2020 += students;
                    
                    if (!regionChanges[region].programs[programName]) {
                        regionChanges[region].programs[programName] = {
                            students2023: 0,
                            students2020: 0
                        };
                    }
                    regionChanges[region].programs[programName].students2020 += students;
                });
            });
            
                // Вычисляем процентные изменения для каждого региона
                for (const region in regionChanges) {
                    const data = regionChanges[region];
                    if (data.total2020 > 0) {
                        data.changePercent = ((data.total2023 - data.total2020) / data.total2020) * 100;
                    } else {
                        data.changePercent = 0;
                    }
                }
            } // Закрываем функцию analyzeRegionChanges
                
                // Обновляем стили регионов на карте
// Функция для анализа изменений по регионам
function analyzeRegionChanges() {
            // Создаем объект для хранения данных по регионам
            const regionChanges = {};
            
            // Сначала собираем данные за 2023 год
            universityData.forEach(university => {
                const region = university.region;
                if (!region) return;
                
                if (!regionChanges[region]) {
                    regionChanges[region] = {
                        total2023: 0,
                        total2020: 0,
                        programs: {}
                    };
                }
                
                if (university.analis_reg_data) {
                    university.analis_reg_data.forEach(program => {
                        const programName = program["Реализуемые УГН(С)"];
                        const studentsStr = program["Приведенный контингент студентов"];
                        const students = parseFloat(studentsStr ? studentsStr.replace(',', '.') : '0');
                        
                        regionChanges[region].total2023 += students;
                        
                        if (!regionChanges[region].programs[programName]) {
                            regionChanges[region].programs[programName] = {
                                students2023: 0,
                                students2020: 0
                            };
                        }
                        regionChanges[region].programs[programName].students2023 += students;
                    });
                }
            });
            
            // Затем собираем данные за 2020 год
            universityData2020.forEach(university => {
                const region = university.region;
                if (!region) return;
                
                if (!regionChanges[region]) {
                    regionChanges[region] = {
                        total2023: 0,
                        total2020: 0,
                        programs: {}
                    };
                }
                
                if (university.analis_reg_data) {
                    university.analis_reg_data.forEach(program => {
                        const programName = program["Реализуемые УГН(С)"];
                        const studentsStr = program["Приведенный контингент студентов"];
                        const students = parseFloat(studentsStr ? studentsStr.replace(',', '.') : '0');
                        
                        regionChanges[region].total2020 += students;
                        
                        if (!regionChanges[region].programs[programName]) {
                            regionChanges[region].programs[programName] = {
                                students2023: 0,
                                students2020: 0
                            };
                        }
                        regionChanges[region].programs[programName].students2020 += students;
                    });
                }
            });
            
            // Вычисляем процентные изменения для каждого региона
            for (const region in regionChanges) {
                const data = regionChanges[region];
                if (data.total2020 > 0) {
                    data.changePercent = ((data.total2023 - data.total2020) / data.total2020) * 100;
                } else {
                    data.changePercent = data.total2023 > 0 ? 100 : 0;
                }
            }
            
            // Обновляем стили регионов на карте
            updateRegionStyles(regionChanges);
        }

        // Функция для обновления стилей регионов на основе изменений
        function updateRegionStyles(regionChanges) {
            // Удаляем предыдущие слои регионов, если они есть
            if (regionLayers) {
                for (const layer in regionLayers) {
                    if (regionLayers[layer] && map.hasLayer(regionLayers[layer])) {
                        map.removeLayer(regionLayers[layer]);
                    }
                }
            }
            
            // Создаем новый объект для слоев
            regionLayers = {};
            
            if (!regionData || !regionData.features) {
                console.error('Данные регионов не загружены или имеют неверный формат');
                return;
            }
            
            // Добавляем полигоны регионов с новыми стилями
            L.geoJSON(regionData, {
                style: function(feature) {
                    if (!feature || !feature.properties || !feature.properties.name) {
                        return {
                            color: "#ff7800",
                            weight: 2,
                            opacity: 1,
                            fillColor: "#ffffcc",
                            fillOpacity: 0.7
                        };
                    }
                    
                    // Находим данные для этого региона
                    const regionName = feature.properties.name;
                    let changePercent = 0;
                    
                    // Ищем соответствующие данные в regionChanges
                    for (const region in regionChanges) {
                        if (region && regionName && 
                            (region.toLowerCase().includes(regionName.toLowerCase()) || 
                             regionName.toLowerCase().includes(region.toLowerCase()))) {
                            changePercent = regionChanges[region].changePercent;
                            break;
                        }
                    }
                    
                    // Определяем цвет в зависимости от процента изменения
                    let fillColor;
                    if (changePercent > 20) {
                        fillColor = '#006837'; // Сильный рост (темно-зеленый)
                    } else if (changePercent > 5) {
                        fillColor = '#78c679'; // Рост (зеленый)
                    } else if (changePercent < -20) {
                        fillColor = '#e31a1c'; // Сильное снижение (темно-красный)
                    } else if (changePercent < -5) {
                        fillColor = '#fd8d3c'; // Снижение (оранжевый)
                    } else {
                        fillColor = '#ffffcc'; // Незначительные изменения (светло-желтый)
                    }
                    
                    return {
                        color: "#ff7800",
                        weight: 2,
                        opacity: 1,
                        fillColor: fillColor,
                        fillOpacity: 0.7
                    };
                },
                onEachFeature: function(feature, layer) {
                    if (!feature || !feature.properties || !feature.properties.name) {
                        return;
                    }
                    
                    const regionName = feature.properties.name;
                    let changePercent = 0;
                    let changeText = "Нет данных";
                    
                    // Ищем данные для этого региона
                    for (const region in regionChanges) {
                        if (region && regionName && 
                            (region.toLowerCase().includes(regionName.toLowerCase()) || 
                             regionName.toLowerCase().includes(region.toLowerCase()))) {
                            changePercent = regionChanges[region].changePercent;
                            changeText = changePercent.toFixed(1) + "%";
                            if (changePercent > 0) {
                                changeText = "+" + changeText;
                            }
                            break;
                        }
                    }
                    
                    // Добавляем всплывающее окно с информацией
                    layer.bindPopup(`
                        <strong>${regionName}</strong><br>
                        Изменение числа студентов (2020-2023): ${changeText}
                    `);
                    
                    // Сохраняем слой для возможного последующего удаления
                    regionLayers[regionName] = layer;
                }
            }).addTo(map);
        }

        // ... (остальной код остается без изменений) ...
    </script>
</body>
</html>